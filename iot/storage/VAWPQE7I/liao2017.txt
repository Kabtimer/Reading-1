Received August 7, 2017, accepted September 12, 2017, date of publication September 22, 2017, date of current version October 25, 2017.
Digital Object Identifier 10.1109/ACCESS.2017.2755858

Multi-Hop LoRa Networks Enabled by Concurrent Transmission
CHUN-HAO LIAO , GUIBING ZHU, DAIKI KUWABARA, MAKOTO SUZUKI, AND HIROYUKI MORIKAWA
School of Engineering, The University of Tokyo, Tokyo 113–8656, Japan
Corresponding author: Chun-Hao Liao (liao@mlab.t.u-tokyo.ac.jp)
This work was supported in part by the Cross-Ministerial Strategic Innovation Promotion Program, ‘‘Infrastructure Maintenance, Renewal and Management Technology,’’ in part by JSPS Grant-in-Aid for Scientiﬁc Research (A) under Grant JP16H02358, and in part by JSPS KAKENHI under Grant JP16J08682.

ABSTRACT In this paper, we strive to construct an efﬁcient multi-hop network based on the sub-GHz lowpower wide-area technology. Speciﬁcally, we investigate the combination of LoRa, a physical-layer standard that can provide several-kilometer outdoor coverage, and concurrent transmission (CT), a recently proposed multi-hop protocol that can signiﬁcantly improve the network efﬁciency. The main contributions of this paper are threefold. 1) Since the CT enhances the network efﬁciency by allowing synchronized packet collisions, the performance of the physical-layer receiver under such packet collisions needs to be carefully examined to ensure the network reliability. We ﬁrst extensively evaluate the LoRa receiver performance under CT to verify that LoRa is compatible to CT. Speciﬁcally, we ﬁnd that, due to the time-domain and frequencydomain energy spreading effect, LoRa is robust to the packet collisions resulting from CT. 2) We further ﬁnd the receiver performance under CT can be further improved by introducing timing offsets between the relaying packets. In view of this, we propose a timing delay insertion method, the offset-CT method, that adds random timing delay before the packets while preventing the timing offset from diverging over the multi-hop network. 3) We conduct proof-of-concept experiments to demonstrate the feasibility of CT-based LoRa multi-hop network and the performance improvement brought by the proposed offset-CT method.

INDEX TERMS LoRa, concurrent transmission, multi-hop networks, mesh networks, communication networks, relay networks, ad hoc networks.

I. INTRODUCTION In the upcoming Internet of Things (IoT) era, smart systems, such as energy management and surveillance control systems, are expected to be widely deployed in buildings [1]. Moreover, in many use cases, such as school campuses or house complexes, the smart systems need to provide coverage over several buildings. To realize such systems, it is essential to have a wide-coverage but low-power wireless network that can robustly connect the indoor devices deployed over several buildings. Also, it is desirable for such networks to be independent from any infrastructures such as base stations so that the users can autonomously and easily deploy the systems. In this paper, we particularly referred to such self-reliant wireless network that consists of only low-power indoor devices while covers several buildings as the multiple-building area networks (MBAN).
Recently, a new breed of communication technologies named low-power wide-area (LPWA) networks has recently been proposed to speciﬁcally address the needs of long-range

and low-power IoT applications [2]. Comparing to the conventional 2.4-GHz standards (e.g. IEEE 802.15.4 [3]) that suffer from weak penetration capability and heavy in-band interference, LPWA utilizes the sub-GHz band and is designed to provide a coverage of several kilometers in an outdoor environment. However, even with such long transmission range, achieving extensive indoor coverage is still very difﬁcult by a single-hop star topology unless the base stations are deployed with enough density and in proper locations [4]. In the infrastructure-free MBAN, a multi-hop relay network is still necessary to ensure reliable any-to-any communications.
In this work, we strive to construct a robust and efﬁcient multi-hop network based on the Sub-GHz LPWA technology to meet the requirements of MBAN. Speciﬁcally, we focus on the combination of the LoRa physical-layer standard with the concurrent transmission (CT) multi-hop protocol. (We particularly refer to the CT-based multi-hop LoRa network based as CT-LoRa.)

21430

2169-3536 
 2017 IEEE. Translations and content mining are permitted for academic research only. Personal use is also permitted, but republication/redistribution requires IEEE permission.
See http://www.ieee.org/publications_standards/publications/rights/index.html for more information.

VOLUME 5, 2017

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

• The LoRa physical-layer standard: Among many competing LPWA technologies (such as SigFox [5] or Wi-SUN [6]), the LoRa standard [7] is one the most promising standards. LoRa adopts the M-ary frequency shift keying (FSK) modulation and Chirp Spread Spectrum (CSS) technique [7], which makes it robust to interference and allow the transmission range to be longer than 10 km [8]. More importantly, LoRa adopts symmetric modulation for uplink and downlink, which allows the terminal devices to establish device-to-device (D2D) link and facilitates the construction of ad hoc relay networks.
• The CT ﬂooding multi-hop protocol: CT is a highly efﬁcient ﬂooding protocol that recently revolutionized the design of the IEEE-802.15.4-based multi-hop networks [9]–[13]. Instead of trying to avoid packet collisions, CT allows multiple nodes to transmit packets that carry the same content simultaneously. By allowing such synchronized packet collisions, CT enables fast back-to-back packet relaying which greatly improve the efﬁciency of the network. Many works [14], [15] have conﬁrmed that no matter from energy consumption, reliability, or latency point of view, CT provides a better or comparable performance when compared with the state-of-the-art multi-hop protocols. Moreover, in the recent wireless sensor network competitions [16], [17], the CT-based protocols [18], [19] won the ﬁrst prizes in a row, which further validates the practicality and superiority of CT.
Although CT facilitates the construction of highly efﬁcient multi-hop networks, it is not generally applicable to any wireless standards. Speciﬁcally, as we have shown in our previous work [20], due to the inevitable timing offset and carrier frequency offset (CFO) between the transmitters, even though the colliding packets carry identical contents, there are still several non-ideal effects that degrade the reliability of the receivers. We further showed that the receiver performance under such packet collisions is vastly different from standard to standard, and a careful physical-layer investigation on the conditions that enable reliable receptions under the packet collisions is an essential step for constructing a reliable CT-based network.
In this work, we show the feasibility of CT-LoRa by 1) providing the aforementioned physical-layer investigations on the LoRa receivers, 2) proposing a method to increase the reliability of CT-LoRa, and 3) carrying out practical MBAN experiments using CT-LoRa. The main contributions of this work are elaborated as follows.
A. COMPREHENSIVE RECEIVER PERFORMANCE INVESTIGATION We investigate on the physical-layer performance of LoRa receiver under CT by extensive simulations and experiments. We ﬁnd that the LoRa receiver shows a unique characteristic than the other standards due to its high-order M-ary FSK property. Speciﬁcally, with the narrow subcarrier
VOLUME 5, 2017

spacing of such a modulation (30.5 Hz in the narrowest case), even a small CFO could turn the identical-content packet collisions into totally independent ones. Therefore, LoRa receiver could survive only when the capture effect happens, i.e. when there is a packet whose power is signiﬁcantly stronger than the others’. However, we also ﬁnd that the required power difference for capture effect to happen in LoRa modulation is much lower than the other standards due to the time-domain and frequency-domain energy spread effects. As a conclusion, LoRa can survive CT with high possibility.
B. THE PROPOSAL OF THE OFFSET-CT METHOD In order to enhance the time-domain energy spreading effect and further improve the receiver reliability, we further propose the offset-CT method, which is a simple but effective method to increase the timing offset between the packets while maintaining a virtual timing alignment of each hop. The novelty of this proposal is twofold. First, for the practical CT-LoRa usage where the transmitter number cannot be determined, we propose to introduce a random timing delay uniformly distributed between 0 and one-symbol time before every retransmission of the relay packet. Second, in order to prevent the timing offset from diverging, we propose to carry the delay information in each packet, so that the relay who successfully demodulate the packet could insert the complementary delay to align the timing. (Note that, this method is only feasible for the technology like LoRa who survive the CT purely by capture effect.)
C. PROOF-OF-CONCEPT EXPERIMENTS FOR MBAN We conduct a series of experiments to show the feasibility of CT-LoRa and the validity of the proposed offset-CT method. Speciﬁcally, we test two typical MBAN scenarios - the lowdensity scenario and the high-density case. The typical scenario results show that CT-LoRa is very reliable even without offset-CT. Next, we test the critical scenario for CT, where multiple nodes are put closely to each other to make the power offset between the packet very small. In the critical scenario, we show that offset-CT signiﬁcantly improves the packet reception rate (PRR).
II. RELATED WORKS: AN OVERVIEW OF LoRa AND CT In order to help the reader better understand this paper, we ﬁrst brieﬂy review the two fundamental technologies, the LoRa physical-layer standard, the CT ﬂooding multi-hop protocol, and the physical-layer issues of CT, in this section.
A. THE LoRa MODULATION From the waveform analysis [21]–[23] and the public information [7], it can be inferred that LoRa is a chirp-modulated high-order M-ary FSK system.
First, from the time-frequency spectrogram shown in Fig. 1 (modiﬁed from the ﬁgures in [21]), it can be seen that the LoRa packet consists of a series discontinuous chirp symbols. Despite the two down-chirps in the end of preamble part
21431

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

FIGURE 1. The spectrogram excerpt of the LoRa signal modified from [21]. Subplot (a) shows the preamble part with several up-chirps for packet detection, gain control, and frequency recovery and down-chirps for the start of frame delimiter (SFD). Subplot (b) shows the data part consisting of several discontinuous up-chirps, where the data is modulated by the initial position of each chirp.

FIGURE 2. One possible realization of the LoRa transceiver. Subplot (a) and (b) show the transmitter and receiver part, respectively.
(the start of frame delimiter (SFD)), the other chirps are linear up-chirp that always shifts toward the positive direction with the same slope until reaching the edge of the frequency band. This indicates that the chirp is used only for spectrum spreading and not for data modulation. Moreover, we can see that the initial positions of the chirp in the data part vary from symbol to symbol, which suggests that it is the initial point of each chirp that is used for data modulation. In other words, if removing the frequency shift caused by the chirps, the LoRa is basically an FSK modulation system.
Second, from the document of LoRa modulation speciﬁcation [7], one LoRa symbol consists of 2SF samples and carries SF coded bits, where SF is the spreading factor. This suggest that LoRa is a 2SF -ary FSK system, where the frequency band is divided into 2SF discrete subcarriers, and only one subcarrier per symbol would be selected for data transmission. To be more speciﬁc, it is the position of the selected subcarrier not the signal loaded on that subcarrier that represents the data.
Fig. 2 shows a possible realization of the LoRa transceiver structure. The bit stream is ﬁrst interleaved and encoded. Then, every SF bits from the coded stream are then mapped to a 2SF bits to the inverse fast Fourier transform (IFFT) engine for the 2SF -ary FSK modulation. Finally, the time-domain signal is further modulated by the chirp signal. In the receiver, the received signal is ﬁrst de-chirped and passed to an fast Fourier transform (FFT) engine. The demodulation is done by simply selecting the subcarrier with maximum power at the FFT output.
21432

FIGURE 3. The operation of the CT flooding protocol. An initiator starts the first packet transmission, and the other relay nodes simply do immediate retransmission after the reception. The total replay can be shrink to only a few packet length. On the other hand, synchronized packet collisions may happen frequently in this protocol. Although it has been experimentally proven that such collisions do not result in significant packet losses in the IEEE 802.15.4 system, the receiver’s tolerance to such packet collision varies from standard to standard.
B. THE CT FLOODING PROTOCOL The CT ﬂooding is a joint network- and link-layer protocol for wireless multi-hop networks ﬁrst proposed in [9]. While ﬂooding describes the broadcast-based network-layer behavior, CT describes the link-layer behavior of the relay nodes. As illustrated in Fig. 3, in each packet ﬂooding, there would be one and only one node serving as the initiator. The initiator broadcast the ﬁrst packet to trigger the ﬂooding. Every node who successfully receives the packet for the ﬁrst time shall then perform immediate retransmission as another broadcast. The same procedure carries on until the packet ﬂoods over the whole network.
The essential difference between CT and the conventional link-layer protocol (e.g. CSMA/CA adopted in IEEE 802.15.4 [24]) is the view toward packet collisions. While the conventional ones strive to avoid packet collisions, CT embraces the synchronized packet collisions that happen when multiple relays perform immediate retransmissions at the same time. By removing the overhead of collision avoidance mechanism, the packet can ﬂood through the network very quickly through the seamless relays. This property is particularly important when constructing a LoRa multi-hop network since the LoRa packets tend to be long (an order of hundred milliseconds to even seconds) and the conventional collision avoidance mechanism could easily result in very long latency and wake-up time.
To accommodate packet transmissions from different initiators, a super scheduler is needed to coordinate the transmission order in a Time-Division-Multiple-Access (TDMA) manner. Note that, the TDMA-based coordination can be
VOLUME 5, 2017

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

easily implemented in the CT-based network since the nodes are naturally synchronized by each ﬂooding. To be speciﬁc, since each node performs immediate retransmission, the node can accurately estimate the absolute transmission timing of the initiator by subtracting the receiving time by multiplication of the packet length and the hop count. Therefore, all the nodes can perform the synchronization once whenever the super scheduler starts a ﬂooding.
The super scheduler assigns dedicated timing slots for the nodes that want to transmit packets. The nodes serve as an initiator in its own slot and transmit a packet using CT ﬂooding while serving as a relay in others’ slots. The duration of the slot is set to be just long enough so that a packet ﬂooding can ﬁnish within one slot. Speciﬁcally, the duration of a packet ﬂooding is as long as the product of the packet length times and the diameter of a network in terms of hop count. Using the interpretation in [14], the CT ﬂooding network acts like a bus connecting all the nodes. Only one node can access the bus at a time, but each access is very short. In [14], [15], schedulers for the CT ﬂooding that can dynamically arrange the transmission order according to the real-time trafﬁc demands are proposed.
The superiority of CT against the state-of-the-art networkand link-layer protocols has been veriﬁed in [14], [15]. When comparing to other multi-hop protocols, CT achieves a much lower energy consumption due to the accurate duty cycling enabled by the well-scheduled TDMA mechanism. Moreover, since the packet could be heard several times in one ﬂooding, CT also enjoys a higher reliability. In addition, although every node in CT needs to dedicate to the current ﬂooding so that the parallel transmissions are prohibited, the short ﬂooding duration in CT compensates the loss in the network utility.Finally, CT does not require any knowledge about of the topology and maintains no routing table, which makes CT very lightweight and robust to mobile scenarios.
C. THE PHYSICAL-LAYER EFFECTS OF CT Unlike the conventional multi-hop protocols that try to prevent packet collisions, CT exposes the physical-layer receivers under synchronized packet collisions to exchange for higher efﬁciency in the upper layers. Therefore, the essential prerequisite for CT to be effective is to ﬁnd the sufﬁcient conditions for receivers to survive such synchronized collisions.
First of all, many success receptions under CT can be attributed to the capture effect [25], which originally refers to a phenomenon in the FM system that only the strongest signal of multiple co-channel ones would be demodulated. In the CT researches, it has been widely adopted to describe the successful receptions of the strongest packet when its power is large enough comparing to the others’. The receiver that can survive CT should have a low Signal-to-Interference-plusNoise Ratio (SINR) requirement to allow the capture effect to happen easily. On the other hand, for the cases that the reception is not captured by a single packet, the inevitable timing offset and CFO between the packets could affect
VOLUME 5, 2017

the reception. Speciﬁcally, the timing offset between packets results in an effect similar to the multi-path channel, which leads to inter-symbol interference (ISI) and frequencyselective fading effect. Similarly, the CFO results in an effect that similar to the mobile channel, which leads to inter-carrier interference (ICI) and a fast-fading like effect more often called beating. The receiver behavior should be carefully investigated to identify the surviving condition against these offsets.
In the context of IEEE 802.15.4 system, there have been many studies trying to conduct the aforementioned investigations. Speciﬁcally, many experimental results [26]–[28] have veriﬁed that a 3 dB power difference is sufﬁcient for the packets to be captured. Moreover, for the non-capture cases, the accuracy of the timing synchronization has been proven to be critical to the reliability of packet reception, and the synchronization accuracy needs to be within 0.5 µs [9]. Finally, we have proven in [20] that it is the direct sequence spread spectrum (DSSS) adopted in the IEEE 802.15.4 standard that allows the receiver to survive the beating effect.
III. THE LoRa RECEIVER PERFORMANCE UNDER CT The section describes the ﬁrst contribution of this paper a comprehensive investigation into the LoRa receiver performance under CT. We shall prove that LoRa can survive CT with high possibility. To prove this, we shall ﬁrst discuss the unique property of LoRa modulation and how the receiver behaves under CT. Next, we shall evaluate the physicallayer performance of LoRa receiver under CT by extensive simulations and experiments.
A. HOW CT AFFECTS LoRa The LoRa has two unique characteristics that make it behave very differently than other low-power wireless standards under CT. (Our discussion mainly focuses on the low-rate LoRa mode with high SF and narrowest bandwidth that provides wide coverage.)
The ﬁrst feature is its long symbol time which is aiming to trade for good sensitivity performance. Speciﬁcally, when the LoRa is conﬁgured at the lowest rate mode (with SF and the bandwidth being 12 and 125 KHz, respectively), one data symbol consist of 4096 samples, which is as long as 32.7 ms. In CT scenario, the long symbol makes LoRa immune to the beating effect caused by CFO. As we mentioned in the previous section, beating is a fading-like effect, which results in bursty demodulation error when deep fading occurs. In our previous work [20], we have shown that the effect of beating is negligible if the fading duration of the beating is narrower than the symbol time. Moreover, we showed that the beating caused by CFO typically has a fading duration of the order of several µs. Since the LoRa has a millisecond-order symbol time, it is very unlikely for the beating to deeply fade a whole LoRa symbol.
The second feature of LoRa, which is also empowered by the long symbol length, is that LoRa adopts a very highorder M-ary FSK modulation in order to increase the spectral efﬁciency. As a result, the frequency deviation of M-ary FSK
21433

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

FIGURE 4. An example of the LoRa demodulation under a two-transmitter CT scenario. The stronger packet (blue arrow) is treated as the wanted signal by the receiver, while the weaker one (red arrow) becomes the interference. Since the CFO biases the interference to another subcarrier, the wanted packet could only be successfully decoded when the power offset is large enough. Subplot (a) illustrates a case without energy spreading effect, where the CFO and the timing offset are the integer times of fdev and TS , respectively. When the CFO is not the integer of fdev (Subplot (b)), or the timing offset is not the integer times of TS (Subplot (c)), the energy of the interference is spread on multiple subcarriers and results in larger power offset.

modulation is extremely small comparing to CFO. Specifically, when LoRa is conﬁgured as the lowest-rate mode, the FSK is in 4096-ary, and the frequency deviation is only 30.5 Hz, while the CFO between the transmitters typical has a standard deviation of several KHz. In the CT scenario, even though that the concurrently transmitted packets all carry the same payload, the CFO could easily bias the FSK modulation and distort the packet as if they are carrying independent payloads. To illustrate, Fig. 4 shows an example of LoRa demodulation under a CT scenario of two transmitters, where the stronger packet is treated as the wanted signal, and the weaker one that is biased by CFO appears to be an independent interference tone on the FFT output.
Under such independent packet collisions, the capture effect (the presence of a signiﬁcantly strong packet) is obviously the only reason that the packet reception could succeed, and this seems to make LoRa incompatible with CT. However, also thanks to the high-order M-ary FSK modulation property, there are two effects that allow an extra margin for the capture effect, and hence signiﬁcantly increase the probability of surviving. We refer to these two effects as the frequency-domain and time-domain energy spreading effect.
• Frequency-domain energy spreading effect: Since the CFO is a continuous random value that is typically larger than the frequency deviation, it is very likely that the interference tone locates between two subcarriers. In such cases, the energy of the interference tone would spread among the adjacent subcarriers as shown in Fig. 4 (b), and hence results in an extra power offset between the strongest tone and interference tone. We refer to this effect as the frequency-domain energy spreading effect. The maximum frequencydomain energy spreading happens when the interference locates exactly in the middle of two subcarriers so that the energy spread out on that two adjacent are equal.
21434

• Time-domain energy spreading effect: The other energy spreading effect happens when there is timing offset between the received packets. We use the example in Fig. 4 (c) to illustrate. When there is timing offset, each symbol of the wanted packet would be affected by two adjacent symbols of the interference packet, and each interfering symbol contributes only part of its power. Since each LoRa symbol carries independent SF bits, the probability for the adjacent symbols to be different is (2SF − 1)/2SF , which is very close to 1 since SF is large in LoRa. Therefore, the partial power of interference would be very likely to locate on two different tones, which also results in more power margin for demodulation. Moreover, we expect that the optimum timing offset would be half of the symbol time, and the resulted power margin is also larger than 3 dB.
We would like to emphasize that the frequency-domain energy spreading effect is a free lunch due to the inevitable deviation of the oscillators. The LoRa receivers naturally enjoy this beneﬁt in the CT scenario. On the other hand, we will propose a timing offset insertion method in next section to further increase the time-domain energy spreading effect. Due to these two energy spreading effects, the LoRa receiver can have a high probability of surviving the CT scenario even without the capture effect. Therefore, LoRa is a good candidate for constructing the CT-based multi-hop network.

B. ANALYSIS ON THE ENERGY SPREAD EFFECT
In this subsection, we analyze the power margin obtained by the two energy spreading effects.
Before the chirp modulation, the baseband signal of an M -ary FSK LoRa symbol using the kth subcarrier can be represented as

sk (t) = ej2πkfd t , (t ∈ [0, Ts])

(1)

VOLUME 5, 2017

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

FIGURE 5. The power margin obtained by the two energy spreading effects. The numerical results of (6) for the three nearest subcarriers (i.e. = −1, 0, and 1) are plotted in each subplot. The X- and Y-axis show the value of α and β, or the value of CFO and timing offset in terms of fd and Ts, respectively. (a) = −1. (b) = 0. (c) = 1.

where Ts and fd are the symbol time and frequency deviation,

respectively Therefore, a de-chirped LoRa symbol using the

k th

subcarrier (k

∈

[−

M 2

,

M 2

− 1])

and

being

affected by a

CFO αfd and a timing offset βTs can be represented as

sk (t) = ej2π(k+α)fd (t−βTs), (t ∈ [βTs, βTs + Ts]), (2)

where α and β are factors for normalizing the CFO and timing

offset, respectively. Without losing of generality, we assume

both

α

and

β

are

in

the

range

of

(0,

1 2

].

As shown in the Fig. 2 (b), after the de-chirp operation,

the non-coherent matched ﬁlter receiver estimates the trans-

mitted FSK symbol by selecting the subcarrier with maxi-

mum magnitude from the outputs of the M matched ﬁlters

as

M −1

mˆ = arg max | (r(nTc)e−j2πmfd nTc )|,

(3)

m∈[−

M 2

,

M 2

−1]

n=0

where mˆ is the estimated subcarrier number, Tc is the chip time, and r(t) is the received signal. Note that, in the LoRa
system, the symbol time Ts, chip time Tc, frequency deviation fd , and system bandwidth W satisfy the following equations.

Ts = MTc =

1 fd

=

M. W

(4)

Assuming that the sk (t) is transmitted and there is no CFO and timing offset, it is straightforward to show that only the kth matched ﬁlter would have the maximal value,
and the other matched ﬁlter would output zero due to the
orthogonality between the subcarriers. By substituting sk (t) for r(t) in (3), the maximal value can be simply calculated
as M .
On the other hand, with the presence of CFO and timing
offset, the orthogonality is corrupted and the energy would be
spread around multiple subcarriers. Since most of the energy would still concentrate on the subcarriers near to the kth one,
we substituting the offset LoRa symbol sk (t) for r(t) in (3) and calculate the corresponding output magnitude of the

VOLUME 5, 2017

(k + )th matched ﬁlter output as

M −1
A( , α, β) = | (sk (nTc) × e−j2π(k+ )fd nTc )|
n=0

M −1

=|

(ej2π

(α− M

)n

)|

n= βM

=

1 |

− ej2π (α−

)(M − βM M

1

−

ej2π

(α− M

)

)

|,

(5)

where · is the ceiling function.

Finally, the power margin can be evaluated by calculating

the ratio between the magnitude A( , α, β) with the maximal

value M of the non-offset case, or speciﬁcally

ρ( , α, β) = 20 × log10(A( , α, β)/M ).

(6)

Fig. 5 illustrates the numerical results of the ρ value for different , α, and β. Speciﬁcally, Subplot (a) to (c) corre-

spond to the case with equal to −1, 0, and 1, respectively. These are the three nearest subcarriers to the kth one. The

X- and Y-axis in each subplot correspond to the value of α and β, respectively.

From the numerical results, the following observations can

be made:

• Most of the energy concentrates on the nearest two sub-

carriers, and the maximal value appears on the nearest

subcarrier with = 0. Therefore the receiver perfor-

mance would be dominated by the case with = 0.

• The results show that the timing offset and CFO help to

increase the power margin. In the the case where = 0

in Fig. 5 (b), a more than 6 dB power margin can be

obtained by the two energy spreading effects if both

α and β are both 0.5.

• The power margin resulting from the time-domain

energy spreading effect is more signiﬁcant than that

from the frequency-domain one.

C. RECEIVER PERFORMANCE SIMULATION In this subsection, we present a series of simulations to evaluate the LoRa receivers performance under CT. We will ﬁrst

21435

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

FIGURE 6. The sensitivity gain simulation results for LoRa receiver performance under a two-transmitter CT scenario over different power, timing offset, and CFO. Each subplot represents a 2-D contour map of sensitivity gain for a specific power offset. The X- and Y-axis are the CFO and timing offset, and the color indicates the degree of sensitivity loss or gain. (a) Power offset: 0 dB. (b) Power offset :1 dB. (c) Power offset: 3 dB.

elaborate the setup of the simulation, including the system model, the metric, and parameter space, and then present the simulation result and the discussion.
1) SYSTEM MODEL In our simulation, we evaluate the receiver performance by the typical one-hop transmitter-channel-receiver model. Speciﬁcally, LoRa packets are ﬁrst generated according to the transmitter block diagram shown in Fig. 2 (a), passed through a CT equivalent channel model, and demodulated by the receiver shown in Fig. 2 (b).
The CT equivalent channel model is a one-hop additive composite channel as shown in Fig. 8 [20]. In this model, a packet is transmitted by multiple transmitters, and each of them has independent power, phase, timing offset, and CFO. The signals from each transmitter are then combined additively. In our simulation, randomly generated 15-byte packets with SF-12 and BW-125KHz mode are used.
2) EVALUATION METRIC To faithfully reﬂect the loss resulting from the CT, we evaluate the receiver performance in terms of the sensitivity gain, deﬁned as the difference of sensitivity performance between CT reception and conventional collision free reception [20]. To calculate the sensitivity gain, we assume that the ﬁrst transmitter is the strongest and with a unitary power and zero offsets, while the power of the other ones is always smaller without losing the generality. After the combination, the signal is ﬁrst attenuated by K dB before fed to the receiver. We also assume that the receiver achieves perfectly timing and frequency synchronization to the stronger transmitter. In our evaluation, we gradually increase the attenuation K until the packet error rate (PER) reaches 1 %, and record the K value as the maximum allowable attenuation. As the ﬁnal metric, we calculate the difference of K value between the CT and collision-free reception and refer to this difference as the sensitivity gain. Note that, since LoRa is a proprietary standard, the adopted interleaving and error correcting code scheme are not open to the public. Therefore, our evaluation is based on the uncoded PER.
21436

3) PARAMETERS SPACE To simplify the evaluation dimension, we ﬁrst evaluate the CT scenario of two transmitters. We evaluate the sensitivity gain under a three-dimensional parameter space consisting of the power offset, the timing offset, and the CFO. Speciﬁcally, the power offset, the timing offset, and the CFO between the two transmitters are swept from 0 to 3 dB, from 0 to 2 symbol time (32.7 ms), and from 0 to 4 frequency deviation (30.7 Hz), respectively. Note that the effect of negative offset is symmetric to the positive one. To reduce redundancy and improve readability, we present the result of the positive offset only. For each combination of the offsets, the corresponding sensitivity gain would be evaluated by more than 1000 randomly generated packets. Finally, the phase offset is set to be a random variable uniform distributed from 0 to 2π for every packet.
4) SIMULATION RESULTS AND DISCUSSIONS Fig. 6 (a) to (c) show the results of the sensitivity gain for power offset 0 dB, 1 dB, and 3 dB, respectively. In these ﬁgures, we use the colored-coded 2D contour maps to illustrate the sensitivity gain, where the darkness of the red color indicates minus sensitivity gain, or more intuitively the sensitivity loss. The X- and Y-axis indicate the CFO and timing offset, respectively.
Several observations can be made from the simulation.
• Capture effect: First, we can ﬁnd the required power offset that ensure the capture effect for LoRa. From Fig. 6 (c), we can see that, similar to the IEEE 802.15.4 system, if there is a 3 dB power offset between that two packets 3 dB, the receiver can enjoy a comparable performance as the collision-free links regardless of the value of the timing offset and the CFO .
• Frequency-domain energy spreading effect: For the non-capture effect show in Fig. 6 (a) and (b), we can see that the CFO value affects the receiver performance signiﬁcantly. Particularly, there is a clear periodicity of the receiver performance that varies according to the CFO value (the horizontal direction). When the
VOLUME 5, 2017

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

FIGURE 7. The CDF function of the sensitivity gain for the two-transmitter case. Each subplot represents the CDF for a specific power offset. The CDF under different timing offset is presented in each figure by the different colored lines. (a) Power offset: 0 dB. (b) Power offset :1 dB. (c) Power offset: 3 dB.

FIGURE 8. The equivalent one-hop channel model of CT consisting of multiple branches with independent power, phase, timing offset, and CFO.
CFO value is the integration times of the fdev, the sensitivity suffers signiﬁcantly. On the other hand, the sensitivity performance improves greatly while the CFO is not a integer times of fdev. This veriﬁes our previous analysis about the frequency-domain energy spreading effect. • Time-domain energy spreading effect: Similar periodicity can also be observed in the time-domain (the vertical direction). The sensitivity suffers the most when the timing offset is the integration times of the symbol time, while the sensitivity performance is comparable to the collision free case when the timing offset is 0.5 times offset from the integer symbol time. This veriﬁes our analysis on the time-domain energy spreading effect. • The slow beating area: Finally, we observe an exceptional bad-performance area between when the CFO is between 0 and 1 fdev in Fig. 6 (a). This is the slow beating region where the fading duration of beating is wider than the symbol. In this region, some symbols could be totally deeply faded and failed to be demodulated. However, the probability for the CFO to full in this region is negligible due the very small fdev of LoRa modulation.
Note that, if the CFO is larger than fdev, the relation between the sensitivity performance and the CFO can be estimated by calculating the remainder after dividing the
VOLUME 5, 2017

CFO by fdev. Moreover, since the standard deviation of CFO in practical systems is a random variable whose standard deviation is typically much larger than the fdev, the remainder can be regarded as a random variable uniformly distributed between 0 and fdev. Therefore, the cumulative distribution function (CDF) of the sensitivity performance can be calculated as shown in Fig. 7, where Subplot (a) to (c) show the CDF versus sensitivity gain for power offset 0 dB, 1 dB, and 3 dB, respectively. The results of different timing offset are also shown in Fig. 7. From the results, we can ﬁnd that in the worse case with 0 dB power offset and zero timing offset, there would be at least 5 dB of sensitivity loss and more than 50 % of change that the sensitivity loss is larger than 15 dB. On the other hand, if the power offset is increased to 1 dB or if there is a 1/8 symbol time of timing offset, the sensitivity loss can be guaranteed to be smaller than 15 dB, and there is 50 % of chance that the loss is less than 10 dB.
D. REAL-CHIP EXPERIMENTS Besides the simulation, we further conduct real-chip experiments to double conﬁrm our analysis about the LoRa receiver’s performance under CT. In the experiment, we focus more on verifying the effect of timing offset on the receiver performance.
We adopt an RF module consisting of a Semtech SX1272 LoRa RF transceiver [29] and an STM32L151 microprocessor [30]. We build up the experiment environment with one initiator, two relays, and one receiver, as illustrated in Fig. 9. The initiator periodically sends out a packet to trig the CT of the two relays, and the receiver is programmed to only listen to the second-hop packets from the relays and record the PRR. For the ﬁrst relay, we let it perform retransmission right after the reception is ﬁnished, while for the second one, we intentionally insert a timing delay before the retransmission.
In order to test the critical scenario, the two relays are put close to each other to reduce the power offset, and the receiver is put in a shielded location such that the received packet is
21437

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

FIGURE 9. The setup for a two-transmitter CT experiment consisting of one initiator, two relays, and one receiver. The receiver is configured to receive only the packets from the relays. A timing delay is intentionally inserted before each retransmission of Relay 2.
FIGURE 10. The experimental result of the two-transmitter CT experiment by using three pairs of RF modules as the relays. The results show a consistent trend that when the timing offset is close to the integer times of TS (32.7 ms), the PRR drops significantly, while the receiver enjoys a high PRR when the timing offset is away from the integer times of TS .
slightly higher than the sensitivity level. Before conducting the real CT experiment, we veriﬁed that the receiver can receive the packet from each individual relay with an over 99% PRR to make sure that the packet loss is caused by CT instead of insufﬁcient SNR. The experiment is conducted several times by using three different pairs of RF modules as the relay nodes. Random generated 15-byte packets are used for evaluation, and the correctness of packet reception is determined by the CRC check. Finally, the experiment is conducted on the 920.6 MHz band, with SF, bandwidth, and code rate being 12, 125 KHz, and 4/5, respectively.
Fig. 10 shows the experimental results, or more speciﬁcally, the relationship between the PRR and the timing offset. We can see that the experimental results match the simulation. While the PPR is worst when the timing offset is close to the integer of TS (32.7 ms), when the timing offset is away from the integer of TS , the receiver can still enjoy a high PRR.
E. SUMMARY We brieﬂy conclude our evaluation result of LoRa receiver under CT. We found that LoRa can survive under CT. First of all, the 3-dB requirement to allow capture effect is no greater than the other CT-compatible standard, such as IEEE 802.15.4 system. Next, in the non-capture scenario, there is a great probability of surviving due to the frequencydomain energy spreading effect. Finally, we show the potential of introducing timing offset to further increase the
21438

surviving probability, while in IEEE 802.15.4 system, timing synchronization error needs to be kept as small as possible to guarantee the receiver performance.
IV. OFFSET CONCURRENT TRANSMISSION As we have shown in the previous section, inserting a timing offset between the concurrently transmitted packets helps to increase the time-domain energy spreading effect and hence improves the receiver performance. In this section, we present a proposal of timing offset insertion method, the offset concurrent transmission (offset-CT) method for increasing the reliability of CT-LoRa. We will prove that the proposed offset-LoRa method: (i) enhances the time-domain energy spreading effect, and (ii) is an add-on on the improvement of the receiver reliability. We will discuss the design considerations, the implementation, and the simulation results that validate the proposal.
A. DESIGN CONSIDERATIONS The timing offset insertion method must be compatible with the original CT protocol while bringing no signiﬁcant degradation to the network performance. Speciﬁcally, the following constraints need to be satisﬁed.
1) SMALL OVERHEAD Introducing timing delay makes the packet transmission time longer and degrades the network utilization. Therefore, we need to ensure that the inserted timing offset is small enough compared to the packet length so that the effect on the network utilization is negligible.
2) SIMPLE AND DISTRIBUTED CALCULATION One of the most important advantages of the CT ﬂooding protocol is its simplicity and the distributed nature. There is no need to gather and maintain the global topology information, and there are also no needs to maintain the routing information. Therefore, in order to be compatible to the CT ﬂooding, the calculation and the insertion of the timing offset needs to be done in a simple and distributed way that does not require global information.
3) TIMING ALIGNMENT BETWEEN EACH HOP As we discussed in Sec. II-B, in the original CT ﬂooding protocol, the nodes are naturally synchronized by each ﬂooding, which greatly facilitates the node management and helps to reduce the power consumption by accurate duty cycling. However, introducing the timing offset in multi-hop networks could ruin the timing synchronization between the nodes. Moreover, a large timing offset could cause packet reception problems.
Fig. 11 depicts an example of such problem, where two packets are transmitted with large timing offsets and the weak one is received ﬁrst. In this example, the receiver has already successfully detected the preamble of the weaker one and enter the timing acquisition or even data demodulation state before the strong packet comes. If the receiver does not
VOLUME 5, 2017

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

FIGURE 11. The illustration of the preamble locking problem caused by large timing offset. When the receiver successfully detects the leading weak packet, the later-coming strong packet could result in the SFD detection fail or the payload demodulation error.

FIGURE 13. The illustration for the offset-CT method. Before each retransmission, two parts of delay (A and B) are inserted. The Part-A delay τ A is a random variable uniformly distributed between 0 to TS . The information of τ A is carried in each packet. The relay which successfully decodes the packet would first insert a Part-B delay with a duration of TS − τ A, and then insert another newly generated random Part-A delay before the retransmission.

FIGURE 12. The experiment result that confirms the preamble locking problem. When the timing offset between the leading weak packet is larger than 100 ms (about 3 TS ), the PRR dramatically drops to 0%.
have the capability of aborting the current packet where there is a later-coming strong signal, the later-coming one would then become a severe interference which may result in the SFD detection failure or the payload modulation error.
To demonstrate the preamble locking problem, we conduct an experiment with one initiator, two relays, and one receiver similar to the one in Sec. III-D. We adjust the position of the two relays so that the packet from Relay 2 is 6 dB larger than that from Relay 1. Similarly, we introduce different timing delay before the retransmission of the Relay 2 and record the corresponding receiver PRR performance as shown in Fig. 12. We can see that when the timing offset is larger than 100 ms (about 3 TS ), the receiver could fail to decode the packet. The maximum allowable timing offset without letting the receiver to be locked by the ﬁrst coming packet depends on the RF modulation design.
In sum, a mechanism to restore the timing alignment between each hop is required to maintain the timing synchronization nature of CT as well as to prevent the timing offset from diverging.
B. IMPLEMENTATION OF OFFSET-CT The offset-CT method is a timing delay insertion method that can addresses the three aforementioned constrains. Specifically, we propose to insert a two-part delay before each retransmission of the relay packet. We call the two parts as Part-A and Part-B delay. Fig. 13 illustrates an example of the timing diagram of the offset-CT method. We then elaborate the detail of these two delay as follows.
• Part-A delay - a uniformly distributed random delay: Each Part-A delay is a independent uniformly distributed random delay for creating the timing offset
VOLUME 5, 2017

between the packets. We set the range of this ran-

dom delay to be one symbol time (TS ). While in the 2-Tx CT cases, the optimum timing offset has been

proven to be half of the symbol time, the optimum

value for the multiple-transmitter scenario is difﬁcult to

ﬁnd. Moreover, in practical CT scenarios, the number of

the transmitters joining the CT is not controllable and

measurable. Therefore, instead of trying optimizing the

timing offsets according to the topology, we introduce

a random delay to generate timing offset between the

packets. As we will show in the later simulation, a uni-

formly distributed random delay is not only easily to

generate, but also provide a signiﬁcant performance

improvement in the multiple-transmitter scenario.

• Part-B delay - a complementary delay: In order to prevent the timing offset from diverging, we insert

another complementary delay to restore the timing align-

ment of each hop. To achieve this, in each packet,

we add an extra ﬁeld in the data to indicate the dura-

tion of the Part-A delay that the packet has undergone

in the previous hop. In our implementation, we use a

5-bit ﬁeld to represent the delay so that there are 32 kinds

of possible realizations for the Part-A delay. When a

relay node successfully receives a packet and decodes

the duration of previous Part-A delay, the relay would

ﬁrst insert a Part-B delay with a duration of TS minus the previous Part-A delay to make the total delay ﬁxed

as Ts. A newly generated Part-A delay would than be added before the retransmission.

To be more speciﬁc, let us consider a situation that Relay i

receives a packet from Relay j which has been relayed by (n − 1)th times (so that Relay i is about to relay the packet for the nth time). We denote the Part-A and Part-B delay inserted by Node i before relaying as τnA,i and τnB,i, respectively. Then,

τnA,i = U (0, Ts), n ≥ 1

(7)

21439

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

τnB,i =

Ts − τnA−1,j, 0,

n≥2 otherwise

(8)

Then, the transmission time of a packet which is about to be relayed for the N th time can then be calculated as

N

Tn = TP + τ1A + (TP + τnB + τnA) +

n=2

N

= TP + τ1A + (TP + Ts − τnA−1 + τnA)

n=2

= TP + (N − 1)(TP + TS ) + τNA,

(9)

where TP is the packet length. We can see that the duration of each relay is ﬁxed as Tp + Ts. With the remaining term τNA, the packets are allowed to be randomly shifted in a range of Ts in each hop.
Note that, the design of carrying individual delay information in each packet is feasible because of the special property of LoRa modulation. As we mentioned in the Sec. III-A, due to the narrow frequency deviation, the CFO would signiﬁcantly bias the packet contents and the LoRa receivers survive the CT mainly by the capture effect. What makes CT-LoRa feasible is the property that LoRa requires only a very small power offset to allow the capture effect. In other words, no matter whether the concurrent transmitted packets carry the same payload or not, the LoRa receiver has a high probability to decode the strongest packet. On the other hand, the conventional CT protocols require the packets to always carry the same payload.

C. OVERHEAD OF OFFSET-CT
The offset-CT method is compatible with the original CT ﬂooding protocol. The only overhead is a slight increase in the transmission time of each packet. Speciﬁcally, the two-part delay increases the equivalent transmission timing of each packet by one symbol time Ts. In addition, an extra ﬁeld is needed to indicate the Part-A delay. In this work, we use a 5-bit number to represent the delay.
Comparing to the total packet length, such overhead is very small. To give a speciﬁc number on the utilization degradation, let us consider a typical LoRa packet with a payload of 15 bytes. We assume the SF and code rate to be 12 and 4/5, respectively, and the other parameters (e.g. the preamble and header length) to be the default setup. The transmission time of a packet can be evaluated by the following equation given in [29].

TP = (22.25 +

8PL − 4SF + 42 4SF

×

4 CR

)Ts

,

(10)

where PL is the payload length in byte and CR is the code rate. Thus, the transmission time of the aforementioned packet can be calculated as 35.25 Ts. With the same equation, we can evaluate the transmission time after applying the offset-CT method to be 36.25 Ts, and the utilization degradation is only 2.84 %.

21440

D. EVALUATION OF THE OFFSET-CT METHOD Next, we present a series of simulations and experiments to show that the proposed offset-CT method can 1) signiﬁcantly improve the receiver performance in the multi-transmitter scenario, and 2) restore the timing alignment of each hop.
1) RECEIVER PERFORMANCE EVALUATION We conduct similar simulations and experiments to evaluate the receiver performance under the multiple-transmitter scenarios. The setups are similar to the previous two-transmitter evaluations.
a: SIMULATIONS The purpose of the simulation is to not only veriﬁed the effect of the random timing offset, but also to ﬁnd a proper range for the uniformly distributed random variable. We again evaluate the uncoded sensitivity gain under the power, timing offset, and CFO. We set the CFO to be a Gaussian random variable with 1 KHz of standard deviation. (As long as the value is large enough, it is irrelevant to the ﬁnal results.) Meanwhile, we model the timing offset as a uniformly distributed random variable with different ranges. For the power offset, we set the power of the strongest packet to be unitary and make the other packets have the same power offset against the strongest one. Speciﬁcally, we evaluate the cases with 0 to 3 dB power offset. The other parameters are the same as the two-transmitter ones.
Fig. 14 (a) to (c) show the results of the sensitivity gain for the cases with 4, 8, and 16 transmitters, respectively. From these ﬁgures, the following observations can be made.
• The more transmitters, the worse performance. Since the CT packets biased by CFO act as independent packets, having more transmitter would only degrade the performance. We can also see that, in high-transmitter number case, a higher power offset is required for the receiver to survive the packet collisions.
• Introducing the timing offset helps to improve the receiver performance signiﬁcantly. However, we can see that a larger timing offset does not always result in a better performance.
• From the simulation results, we select the range of uniformly distributed random timing offset to be one symbol time (32.7 ms) in our system.
b: EXPERIMENTS In the experiment, we test the receiver performance with different numbers of relays to verify the performance improvement resulting from the offset-CT method. The experiment setup is similar to the previous two-transmitter experiment (Sec. III-D) with one initiator, 2∼16 relays, and one receiver as shown in Fig. 15. Each relay inserts a uniformly distributed random delay from 0 to TS before the retransmission using the offset-CT method. Since this is the ﬁrst-hop relay, the Part-B delay is always zero. For reference, we also evaluate the PRR performance of conventional CT without inserting the random delay. Again, those relay
VOLUME 5, 2017

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

FIGURE 14. The simulation results for the LoRa receiver performance under multiple-transmitter CT scenarios over different power and timing offset. The three subplots represent a 2-D contour map of sensitivity gain under 4-, 8-, and 16-transmitter CT scenarios, respectively. The X-axis is the value of power offset, and the Y-axis is the range of the uniformly distributed random timing offset. The CFO is modeled as a Gaussian random variable whose standard deviation is sufficiently large. (a) 4 Transmitters. (b) 8 Transmitters. (c) 16 Transmitters.

FIGURE 15. The setup for the multiple-transmitter CT experiment with one initiator, variable numbers (2∼16) of relays, and one receiver. The receiver is configured to receive only the packets from the relays. A random timing delay that uniformly distributed between 0 to TS is inserted before the retransmission of each relay.

nodes are put close to each other to make the power offset small, and we make sure that the receiver has a reliable connection to each relay in the collision-free scenario. The other setups are the same as the two-transmitter ones.
Fig. 16 shows the PRR under different relay nodes, where the red bars show the results without inserting timing offset, while the blue ones show those with timing offset. We can see that the results match the conclusion we draw from the simulation. Speciﬁcally, the PRR degrades when there are more relays join the CT. Moreover, we can see that the random timing delay signiﬁcantly improves the PRR by 10% to 30%.
2) TIMING ACCURACY EVALUATION Next, we present the experiment to conﬁrm that the offsetCT method can restore the timing alignment. The experiment setup is shown in Fig. 18. Speciﬁcally, there is one initiator and four groups of relays, where each group contains four nodes. We conﬁgure the relays in each group to receive only the packets from the previous group and the relay in Group 1 receive only the packets from initiator. By this setting, we force the relays to form a linear four-hop network.
Three kinds of timing offset insertion methods are evaluated: 1) the conventional CT where both Part-A and Part-B delays are zero, 2) the offset-CT with both Part-A and Part-B delay, and 3) the naive timing offset method with only Part-A
VOLUME 5, 2017

FIGURE 16. The experimental result of the multiple-transmitter CT experiment with different numbers of relays. The PRR that with and without inserting the random timing offset are shown as the blue and red bars, respectively. The results show that the random timing delay significantly improves the PRR performance.
delay and Part-B delay is zero. We let the initiator periodically transmit packets, and the time stamps of the end of each Part-B delay (the timing of the dashed gray line in Fig. 13) are recorded in each relay. By calculating the difference between the adjacent timing stamps, we gather the statistics of the inter-packet interval (IPI) and calculate its variation.
Fig. 19 shows the experiment results, we can see that the standard deviation of the IPI of the naive random timing offset method increase signiﬁcantly with the hop count. On the other hand, that of the offset-CT method is almost the same as that of the conventional CT and does not increase along with the hop count. This proves that the offset-CT method can effectively restore the timing alignment of each hop. (Note that, the variation of IPI of the conventional CT is not zero because there are some inevitable variations in the hardware and software processing time.)
V. PROOF-OF-CONCEPT EXPERIMENTS FOR MBAN In this section, we present a series of prove-of-concept experiments to show the feasibility of realizing MBAN by
21441

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

FIGURE 17. The deployment map of the typical scenario experiments. Subplot (a) shows the low-density case where 18 nodes are deployed over 14 buildings, and Subplot (b) shows that of the high-density case where 18 nodes are deployed over each floor in 2 buildings. The floor and the environment information are also marked. In Subplot (a), we mark each reliable one-hop link that has a PRR larger than 90% as one blue dashed line. Note that, in the high-density case, there are too many reliable links (75 links out of 153 pairs). Thus, the links are not marked in Subplot (b) for better readability. The maps are based on the information in [31].

FIGURE 18. The setup for the timing alignment verification with one initiator, four groups of relays, and each group has four node. The relays are configured to receive only the packets from the previous group, and the relay in Group 1 only receive the packets from the initiator.
FIGURE 19. The experimental result of the variation of the IPI versus the hop count. The results show the timing offsets of the offset-CT and the conventional CT stay in a constant level, while those of the naive timing offset method increases significantly when the hop count increases.
CT-LoRa. Two sets of experiments, the typical MBAN scenario, and the critical CT scenario, are conducted. A. TYPICAL MBAN SCENARIO In the ﬁrst set of experiment, we try to emulate the node deployment of a typical MBAN,
21442

1) EXPERIMENT PROCEDURE We use 18 nodes equipped with the RF module described in Sec. III-D for the experiments. Each of them would serve as the initiator in a round-robin manner. The initiator would trigger 100 times of CT ﬂooding by transmitting 100 packets. While one node serves as the initiator, the other nodes would then serve as the relays. If a relay node successfully receives a packet, it would forward the packet, and record the initiator ID and the hop counter of the packet for the performance evaluation. The same packet can be forwarded only once by the same relay. We evaluate the performance of both the conventional CT (i.e. without random timing delay) and the offset-CT method. The parameters of LoRa modulation are the same as those in Sec. III-D.
2) TOPOLOGY One important factor that affects the reliability of CT-LoRa is the density of the node. In the conventional collisionavoidance-based multi-hop network, a denser deployment could be preferable from the reliability point of view, since it is more likely for a node to have reliable links to the other nodes. However, from the CT point of view, a dense deployment could in the same time increase the possibility of harmful packet collisions, since there would be more nodes joining the CT and the power offset between the CT packets could also be smaller. In view of this dilemma, we conduct experiments under both low-density and high-density deployments.
• Low-density deployment: In the low-density deployment, we deploy the 18 nodes over 14 buildings such that there are at most two nodes in the same building. In addition, we deploy the node in different ﬂoors to make the topology more sparse. The detail deployment map of the low-density deployment is shown in Fig. 17 (a).
VOLUME 5, 2017

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

We mark every reliable one-hop link (with higher than 90 % of PRR) on the map with blue dashed lines. As the map shows, we try to deploy the nodes in various places, such as corridors, stair rooms, pantries, and ofﬁce rooms. Moreover, some of the nodes are deployed in highly shielded locations, such as toilets without a window or basements. • High-density deployment: In the high-density deployment, we deploy the 18 nodes over 2 adjacent buildings with 8 and 7 ﬂoors, respectively. We uniformly deploy the nodes in every ﬂoor so that there are at most two nodes in the same ﬂoor. The detail deployment map of the high-density topology is shown in Fig. 17 (b). Note that, in the high-density deployment, almost each node is reliably connected many other nodes. Therefore, marking all the reliable one-hop links to would make the map unreadable.

FIGURE 20. The setup of the critical scenario experiment. The packets from the initiator would be relayed to the end node by the four groups of relay nodes, where the numbers of the nodes in each group vary from 2 to 4. The locations of the four groups are carefully selected so that each group can reliably communicate with the previous and next group only.
TABLE 1. The experiment result of the typical scenario.

3) RESULTS AND DISCUSSIONS Table 1 shows the statics of the two experiments, including the worst/average PRR and maximum/average hop count between any two nodes. We also provide estimations to the degree of packet collisions by calculating the average and the maximum number of relays that concurrently transmitting packets to one receiver. Speciﬁcally, we gather the reliable one-hop link information (as plotted in Fig. 17 (a)), construct the ﬂooding diagrams starting from each initiator, and count the numbers of the relays that concurrently transmitting to each receiver. Note that, since the packet collisions happen only after the second-hop relay, the ﬁrst-hop collision-free transmissions are ignored in the calculation of the relay numbers. From the results, the following observations can be made.
• The necessity of a multi-hop relay network: The results support our argument that, if the nodes are all deployed indoor and transmitted with low power, a multi-hop relay network is needed to ensure the coverage even with a wide-area standard such as LoRa. We can see that even with the longest spreading factor and narrowest bandwidth, it would still require a maximum of 5-hop relay to link every node deployed in an 180 m × 290 m campus. Even in the high-density topology that covers only two buildings, there are still some highly shielded nodes that need to be covered by three-hop relays.
• The robustness of CT-LoRa: The experiments show an exciting result - CT-LoRa achieves almost 100% PRR in both high-density and low-density topologies. Particularly, in the high-density topology, severe packet collisions do happen. There would be, on the average, three nodes transmitting packets to a receiver in each relay, and the worst case number is seven. The results show that, by deploying in different ﬂoors or rooms, the resulted power offset is already large enough for the nodes to survive such packet collisions even without offset-CT.
VOLUME 5, 2017

FIGURE 21. The deployment map of the critical scenario experiment. The floor and the environment information are also marked. The lines between the nodes represent reliable one-hop links whose PRR is larger than 90%. The map is based on the information in [31].
• The effect of offset-CT: Since the power offset in the typical scenario already ensures most of the packet receptions to be reliable, the offset-CT method can barely improve the average performance. However, we can still observe signiﬁcant improvements in the cases that with the worst PRR for both high-density and low-density deployment.
B. CRITICAL CT SCENARIOS In the previous experiment, we show that CT-LoRa can deliver a high reliability in the typical MBAN usages. Next, we would like to create a critical scenario for CT-LoRa and evaluate the performance.
1) TOPOLOGY As we have shown in the previous evaluation, the most critical case for a CT-based multi-hop network happens when there are many colliding packets received with the same power level. In order to create this scenario, we intentionally put the nodes close to each other to reduce the power offset. Moreover, we also expect that the reliability would degrade when the hop-count increases. Therefore, we deploy the nodes in a linear topology that showing in Fig. 20 to increase the
21443

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

FIGURE 22. The experimental result of the critical scenario experiment. Subplot (a) and (b) show the PRR and the average hop count of the end node, respectively. The three sets of bars correspond to different node number in a group. In each set, the yellow and the blue bars show the results of the conventional CT method and the offset-CT method, respectively. (a) PRR of the end node. (b) Average hop count of the end node.

hop count. Speciﬁcally, we select two nodes as the initiator and the end node, and deploy four groups of relays to connect them. In each group, the nodes are put as close as possible to each other. We properly choose the location of each group (as shown in Fig. 21) so that the nodes in each group has reliable connections to those in the previous and next groups only. Besides, the initiator and the end node only have reliable links to the nodes in Group 1 and 4, respectively.
Note that, although this experiment may looks very similar to the experiment shown in Sec. IV-D.2, there is a fundamental difference. In the experiment in Sec. IV-D.2, the relays in different groups are programmed to receive only the packet from previous group, while in this experiment, the relays in each group sever exactly the same function (the general CT relay function without special limitations), and the linear topology is achieved by the careful location selections. Therefore, this critical scenario could happen in the real world, if the user chooses to deploy the nodes in such a manner.
2) PROCEDURE The setup of the experiment is similar to the experiment under the typical scenario. The difference is just that the initiator is ﬁxed to one node. We conduct three independent experiments by changing the number of the node in each group from 2 to 4 nodes. Again, the performance for both conventional CT (i.e. without random timing delay) and the offset-CT method are evaluated.
3) RESULTS AND DISCUSSIONS We plot the PRR and average hop count of the end node in Fig. 22 (a) and (b), respectively. As we emphasized before, we simply deploy the nodes in a linear topology, while the nodes still follow the basic CT or offset-CT principle to relay the packet. Therefore, it is possible for a packet being relayed back and forth between the groups, so it might take more than 5 hops for a packet to reach the end.
From the results, we can see that, with more nodes in one group, the PRR becomes worse. Moreover, we show that the offset-CT signiﬁcantly improves the PRR as well as reduces the average hop count in the critical scenario. Particularly,
21444

in the case of 4 nodes in a group, the offset-CT improves the PRR from 51% to 77%.
VI. CONCLUSION In this paper, we provided a feasible solution for the MBAN, a network that consists of only low-power nodes while providing extensive indoor coverage over several buildings. Speciﬁcally, we proposed to use the sub-GHz LoRa as the physical-layer standard, and construct a multi-hop network based on the CT protocol. The long transmission range of LoRa ensures the indoor coverage, reduces the number of redundant relay nodes, and keeps the transmission power small. On the other hand, the CT protocol helps to realize a simple but efﬁcient one-to-any fast packet broadcast by introducing the synchronized packet collisions.
To realize a reliable CT-based LoRa multi-hop network, we ﬁrst comprehensively evaluated the LoRa receiver performance under CT to verify if the LoRa can tolerate the packet collision or not. Our evaluation and analysis showed that LoRa is robust to CT. Speciﬁcally, due to the frequencydomain energy spreading effect enabled by the CFO, LoRa can survive the packet collisions with very high possibility even with small power offset. Moreover, we also demonstrate that, by intentionally introduce the timing offset between the packets, the surviving probability can be further increased due to the time-domain energy spreading effect. In view of this, we further proposed the offset-CT method, which introduces a uniformly distributed timing offset between the relayed packets while keeping the timing of each hop aligned by inserting a two-part delay. Finally, we conducted several proof-of-concept experiments. The experiment results showed that CT-LoRa already enjoys a very high PRR performance under the typical MBAN scenario. On the other hand, in the critical scenario where the nodes are put closely to each other, the offset-CT method signiﬁcantly improves the PRR.
REFERENCES
[1] D. Minoli, K. Sohraby, and B. Occhiogrosso, ‘‘IoT considerations, requirements, and architectures for smart buildings—Energy optimization and next-generation building management systems,’’ IEEE Internet Things J., vol. 4, no. 1, pp. 269–283, Feb. 2017.
VOLUME 5, 2017

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

[2] U. Raza, P. Kulkarni, and M. Sooriyabandara, ‘‘Low power wide area networks: An overview,’’ IEEE Commun. Surveys Tuts., vol. 19, no. 2, pp. 855–873, 2nd Quart., 2017.
[3] IEEE Standard for Local and Metropolitan Area Networks—Part 15.4: Low-Rate Wireless Personal Area Networks (LR-WPANs), IEEE Standard 802.15.4-2011, Sep. 2011, pp. 1–314.
[4] J. Petäjäjärvi, K. Mikhaylov, M. Hämäläinen, and J. Iinatti, ‘‘Evaluation of LoRa LPWAN technology for remote health and wellbeing monitoring,’’ in Proc. ISMICT, Mar. 2016, pp. 1–5.
[5] Sigfox. Accessed: Aug. 6, 2017. [Online]. Available: https://www.sigfox.com/
[6] IEEE Standard for Local and Metropolitan Area Networks—Part 15.4: Low-Rate Wireless Personal Area Networks (LR-WPANs) Amendment 3: Physical Layer (PHY) Speciﬁcations for Low-Data-Rate, Wireless, Smart Metering Utility Networks, IEEE Standard 802.15.4g-2012, Apr. 2012, pp. 1–252.
[7] LoRa Modulation Basics, SEMTECH, Camarillo, CA, USA, May 2015. [8] J. Petajajarvi, K. Mikhaylov, A. Roivainen, T. Hanninen, and M. Pettissalo,
‘‘On the coverage of LPWANs: Range evaluation and channel attenuation model for LoRa technology,’’ in Proc. ITST, Dec. 2015, pp. 55–59. [9] F. Ferrari, M. Zimmerling, L. Thiele, and O. Saukh, ‘‘Efﬁcient network ﬂooding and time synchronization with Glossy,’’ in Proc. 10th Int. Conf. Inf. Process. Sensor Netw. (IPSN), Apr. 2011, pp. 73–84. [10] M. Doddavenkatappa, M. C. Chan, and B. Leong, ‘‘Splash: Fast data dissemination with constructive interference in wireless sensor networks,’’ in Proc. NSDI, Apr. 2013, pp. 269–282. [11] M. Doddavenkatappa and M. C. Chan, ‘‘P3: A practical packet pipeline using synchronous transmissions for wireless sensor networks,’’ in Proc. ACM/IEEE IPSN, Apr. 2014, pp. 203–214. [12] V. S. Rao, M. Koppal, R. V. Prasad, T. V. Prabhakar, C. Sarkar, and I. Niemegeers, ‘‘Murphy loves CI: Unfolding and improving constructive interference in WSNs,’’ in Proc. IEEE INFOCOM, Apr. 2016, pp. 1–9. [13] M. Brachmann, O. Landsiedel, and S. Santini, ‘‘Concurrent transmissions for communication protocols in the Internet of Things,’’ in Proc. IEEE LCN, Nov. 2016, pp. 406–414. [14] F. Ferrari, M. Zimmerling, L. Mottola, and L. Thiele, ‘‘Low-power wireless bus,’’ in Proc. ACM SenSys, Nov. 2012, pp. 1–14. [15] M. Suzuki, C.-H. Liao, S. Ohara, K. Jinno, and H. Morikawa, ‘‘Wirelesstransparent sensing,’’ in Proc. EWSN, Feb. 2017, pp. 66–77. [16] Dependability Competition of 2016 International Conference on Embedded Wireless Systems and Networks (EWSN). Accessed: Aug. 6, 2017. [Online]. Available: http://www.iti.tugraz.at/ EWSN2016/cms/index.php?id=49 [17] Dependability Competition of 2017 International Conference on Embedded Wireless Systems and Networks (EWSN). Accessed: Aug. 6, 2017. [Online]. Available: http://www.ewsn2017.org/ dependabilitycompetition1.html [18] J. Klaue, A. Corona, M. Kubisch, J. Garcia-Jimenez, and A. Escobar, ‘‘Competition: RedFixHop,’’ in Proc. EWSN, Feb. 2016, pp. 289–290. [19] R. Lim, R. D. Forno, F. Sutton, and L. Thiele, ‘‘Competition: Robust ﬂooding using back-to-back synchronous transmissions with channel-hopping,’’ in Proc. EWSN, Feb. 2017, pp. 270–271. [20] C.-H. Liao, Y. Katsumata, M. Suzuki, and H. Morikawa, ‘‘Revisiting the so-called constructive interference in concurrent transmission,’’ in Proc. IEEE LCN, Nov. 2016, pp. 280–288. [21] What is LoRa. Accessed: Aug. 6, 2017. [Online]. Available: https://www.link-labs.com/blog/what-is-lora [22] DecodingLora. Accessed: Aug. 6, 2017. [Online]. Available: https://revspace.nl/DecodingLora [23] M. Knight and B. Seeber, ‘‘Decoding LoRa: Realizing a modern LPWAN with SDR,’’ in Proc. GNU Radio Conf., Sep. 2016, vol. 1. no. 1. [Online]. Available: https://pubs.gnuradio.org/index.php/grcon/article/view/8 [24] F. Wang, D. Li, and Y. Zhao, ‘‘Analysis of CSMA/CA in IEEE 802.15.4,’’ Commun., IET, vol. 5, no. 15, pp. 2187–2195, Oct. 2011. [25] K. Leentvaar and J. Flint, ‘‘The capture effect in FM receivers,’’ IEEE Trans. Commun., vol. 24, no. 5, pp. 531–539, May 1976. [26] D. Son, B. Krishnamachari, and J. Heidemann, ‘‘Experimental study of concurrent transmission in wireless sensor networks,’’ in Proc. ACM SenSys, Nov. 2006, pp. 237–250. [27] C. Gezer, C. Buratti, and R. Verdone, ‘‘Capture effect in IEEE 802.15.4 networks: Modelling and experimentation,’’ in Proc. IEEE ISWPC’, May 2010, pp. 204–209.

[28] P. Dutta, S. Dawson-Haggerty, Y. Chen, C.-J. M. Liang, and A. Terzis, ‘‘Design and evaluation of a versatile and efﬁcient receiver-initiated link layer for low-power wireless,’’ in Proc. ACM SenSys, Nov. 2010, pp. 1–14.
[29] Semtech, Camarillo, CA, USA. (2015). SX1272/73860 MHz to 1020 MHz Low Power Long 1150 Range Transceiver. Accessed: Aug. 6, 2017. [Online]. Available: http://www.semtech.com/images/ datasheet/sx1272.pdf
[30] STM32L151x6/8/B—Ultra-Low Power 32-Bit MCU ARM-Based CortexM3, 128 KB Flash, 16 KB SRAM, 4 KB EEPROM, LCD, USB, ADC, DAC, STMicroelectronicsm Geneva, Switzerland, 2016.
[31] UTokto Facilities Equipment Information System (UTFEIS), Univ. Tokyo, Tokyo, Japan, 2017.
CHUN-HAO LIAO received the B.S. degree in electrical engineering and the M.S. degree in electronics engineering from National Taiwan University, Taipei, Taiwan, in 2006 and 2009, respectively, and the Ph.D. degree in electrical engineering from The University of Tokyo, Tokyo, Japan, in 2017. From 2008 to 2009, he was also a Research Assistant with the Institute for Integrated Signal Processing Systems, RWTH Aachen University, Germany. From 2009 to 2014, he was a Communication System Designing Engineer with MediaTek Inc. He is currently a Project Researcher with the School of Engineering, The University of Tokyo. His research interests include baseband signal processing of wireless communication systems, VLSI system design, and network protocols.
GUIBING ZHU received the B.S. and M.E. degrees in automation engineering from the University of Electronic Science and Technology of China, Chengdu, Sichuan, China, in 2011 and 2014, respectively. He is currently pursuing the Ph.D. degree with The University of Tokyo. His research interests include wireless sensor networks and M2M systems.
DAIKI KUWABARA received the B.S. degrees in electrical engineering from The University of Tokyo, Tokyo, Japan, in 2017. He is currently pursuing the Master’s degree with The University of Tokyo. His research interests include wireless communication and human computer interaction.

VOLUME 5, 2017

21445

C.-H. Liao et al.: Multi-Hop LoRa Networks Enabled by Concurrent Transmission

MAKOTO SUZUKI received the B.E., M.S., and Ph.D. degrees in electrical engineering from The University of Tokyo, Tokyo, Japan, in 2005, 2007, and 2010, respectively. Since 2010, he has been with The University of Tokyo, where he is currently a Project Researcher with the School of Engineering. From 2010 to 2017, he was a Research Associate with the Research Center for Advanced Science and Technology, The University of Tokyo. His research interests include ubiquitous computing, wireless sensor networks, embedded systems, and machine-to-machine systems. From 2008 to 2010, he was a JSPS Research Fellow with The University of Tokyo. He is a member of the IEICE. He received the IEICE Best Paper Award in 2010 and the IEICE Communications Society Excellent Student Award in 2009 and 2013. He is a co-funder of Sonas Inc.

HIROYUKI MORIKAWA received the B.E., M.E., and Dr. Eng. degrees in electrical engineering from The University of Tokyo, Tokyo, Japan, in 1987, 1989, and 1992, respectively. Since 1992, he has been with The University of Tokyo, where he is currently a Full Professor with the School of Engineering. From 2002 to 2006, he was a Group Leader with the NICT Mobile Networking Group. His research interests are in the areas of ubiquitous networks, sensor networks, big data/IoT/M2M, wireless communications, and network services. He is a Fellow of the IEICE. He has received more than 50 awards, including the IEICE Best Paper Award in 2002, 2004, and 2010, the IPSJ Best Paper Award in 2006, the JSCICR Best Paper Award in 2015, the Info-Communications Promotion Month Council President Prize in 2008, the NTT DoCoMo Mobile Science Award in 2009, the Rinzaburo Shida Award in 2010, and the Radio Day Ministerial Commendation in 2014. He served as the Technical Program Committee Chair of many IEEE/ACM conferences and workshops, the Vice President of IEICE, the OECD Committee on Digital Economy Policy Vice Chair, the Director of New Generation M2M Consortium, and he sits on numerous telecommunications advisory committees and frequently serves as a consultant to government and companies.

21446

VOLUME 5, 2017

